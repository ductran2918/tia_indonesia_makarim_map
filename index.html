<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Graphic - Smart Responsive</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body, html { 
        margin: 0; 
        padding: 0;
        background: transparent;
        font-family: sans-serif;
    }
    
    .visualization-container {
      width: 100%;
      background: transparent;
      position: relative;
    }
    
    svg { 
        display: block; 
        width: 100%;
        background: transparent;
    }
    
    .group-rectangle {
      fill: none;
      stroke-width: 1px;
      stroke-dasharray: 4;
    }
    .gojek-group {
      stroke: #28a745;
    }
    .special-group {
      stroke: #ffc107;
    }
    .node-image {
      clip-path: none;
    }
    .node-border {
      fill: none;
      stroke-width: 4px;
    }
    text {
      font-family: sans-serif;
      font-size: 12px;
      text-anchor: middle;
      pointer-events: none;
    }
    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-radius: 4px;
      font-size: 14px;         
      font-family: sans-serif;    
      font-weight: normal;       
      pointer-events: none;
      visibility: hidden;
      max-width: 200px;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.4;
      z-index: 1000;
    }
    .circle-header {
        font-family: sans-serif;
        font-size: 14px;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
    }
    .gojek-text {
        fill: #136348;
        font-family: sans-serif;
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
    }
    .special-text {
        fill: #e8bb00;
        font-family: sans-serif;
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
    }
    .legend text {
        text-anchor: start;
    }
    .legend-circle {
        fill: none;
        stroke-width: 8px;
    }
    .chart-title {
      font-family: sans-serif;
      font-size: 18px;
      font-weight: bold;
      text-anchor: middle;
    }
    .chart-subtitle {
      font-family: sans-serif;
      font-size: 14px;
      font-weight: normal;
      text-anchor: middle;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .group-rectangle {
        stroke-width: 1px;
        stroke-dasharray: 3,3;
      }
      .node-border {
        stroke-width: 2px;
      }
      text {
        font-size: 8px;
      }
      .tooltip {
        padding: 4px 6px;
        font-size: 11px;
        max-width: 120px;
        line-height: 1.3;
      }
      .circle-header, .gojek-text, .special-text {
        font-size: 9px;
      }
      .legend text {
        font-size: 8px;
      }
      .legend-circle {
        stroke-width: 4px;
      }
      .chart-title {
        font-size: 13px;
      }
      .chart-subtitle {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>

<div class="visualization-container">
  <div class="tooltip" id="tooltip"></div>
</div>

<script>
(async function() {
  let svg, data, node, legend;
   // Get responsive dimensions - table layout for all screens
  function getResponsiveDimensions() {
    const width = window.innerWidth;
    const isMobile = width <= 500;
    
    // Use a single scale factor for everything
    const baseScale = isMobile ? Math.min(width / 375, 1) : Math.min(width / 1200, 1.5);
    
    // Height to accommodate table layout
    const height = Math.max(400, width * (isMobile ? 0.8 : 0.59));
    
    // Node size for square layout
    const nodeSize = isMobile ? 40 : (60 * baseScale);
    
    return {
      width,
      height,
      isMobile,
      centerX: width / 2,
      centerY: height / 3,
      scale: baseScale,
      nodeSize: nodeSize
    };
  }
  
  // Get node positions - table layout for all screens
  function getNodePositions(dims) {
    const { centerX, centerY, nodeSize, scale } = dims;
    const horizontalSpacing = nodeSize * 2.5;
    const verticalSpacing   = nodeSize * 2;
    const nodeToPersonSpace = dims.isMobile ? 25 : (35 * scale);

    // Start positioning from the legend and work down
    const legendY = dims.isMobile ? 65 : (75 * scale); // 10px after subtitle
    const ministryTextY = legendY + (dims.isMobile ? 30 : (40 * scale)); // 20px after legend
    const gojekTextY = ministryTextY + (dims.isMobile ? 15 : (20 * scale)); // 5px after ministry text
    const gojekRectY = gojekTextY + (dims.isMobile ? 10 : (15 * scale)); // 5px after ex-Gojek text
    const topRowY = gojekRectY + nodeSize * 0.8; // Top of nodes aligns with rect
    const bottomRowY = topRowY + nodeSize + (dims.isMobile ? 30 : (40 * scale)); // 30px between node borders
    
    // Calculate Special staff text position - 10px below Ibrahim's text
    const ibrahimTextY = bottomRowY + nodeToPersonSpace;
    const specialTextY = ibrahimTextY + (dims.isMobile ? 20 : (35 * scale)); // 10px below Ibrahim's text
    
    // Calculate Special staff rectangle bottom
    const specialRectBottom = bottomRowY + nodeSize * 0.8 + nodeToPersonSpace;
    
    // Google text 20px below Special staff rectangle bottom
    const googleTextY = specialRectBottom + (dims.isMobile ? 25 : (30 * scale)); // 20px below special rect
    
    // Ganis node 10px below Google text
    const googleY = googleTextY + (dims.isMobile ? 15 : (20 * scale)); // Adjust this calculation

    const startX = centerX - horizontalSpacing;

    const positions = {
      "Nadiem Makarim":     { x: startX,                       y: topRowY   },
      "Sri Wahyuningsih":   { x: startX + horizontalSpacing,   y: topRowY   },
      "Mulyatsyah":         { x: startX + horizontalSpacing*2, y: topRowY   },
      "Jurist Tan":         { x: startX,                       y: bottomRowY},
      "Ibrahim Arief":      { x: startX + horizontalSpacing,   y: bottomRowY},
      "Fiona Handayani":    { x: startX + horizontalSpacing*2, y: bottomRowY},
      "Ganis Samoedra":     { x: centerX,                      y: googleY + nodeSize * 0.3 }
    };

    return {
      positions,
      gojekRect: {
        x:      startX - nodeSize * 0.8,
        y:      gojekRectY,
        width:  nodeSize * 1.6,
        height: (bottomRowY - nodeSize * 0.8) + (nodeSize * 1.6 + nodeToPersonSpace) - gojekRectY
      },
      specialRect: {
        x:      startX - nodeSize * 0.8,
        y:      bottomRowY - nodeSize * 0.8,
        width:  horizontalSpacing * 2 + nodeSize * 1.6,
        height: nodeSize * 1.6 + nodeToPersonSpace
      },
      // center ex-Gojek text on the first-column node:
      gojekTextX: positions["Nadiem Makarim"].x,
      gojekTextY: gojekTextY,

      specialTextX: centerX,
      specialTextY: specialTextY, // Updated to be 10px below Ibrahim's text
      ministryTextY: ministryTextY,
      googleTextY: googleTextY, // Updated to be 20px below special rect
      legendY: legendY
    };
  }
  
  // Create visualization - unified vertical layout for all screens
  function createVisualization() {
    const dims = getResponsiveDimensions();
    const nodePositions = getNodePositions(dims);
    
    // Clear existing SVG
    d3.select(".visualization-container").select("svg").remove();
    
    // Create new SVG
    svg = d3.select(".visualization-container")
        .append("svg")
        .attr("viewBox", [0, 0, dims.width, dims.height])
        .attr("preserveAspectRatio", "xMidYMid meet")
        .attr("width", dims.width)
        .attr("height", dims.height)
        .style("width", "100%")
        .style("height", "auto");

    // Draw rectangles using unified vertical layout
    drawRectangles(dims, nodePositions);
    
    // Draw nodes if data is available
    if (data) {
      drawNodes(dims, nodePositions);
    }
    
    // Draw legend
    drawLegend(dims, nodePositions);
  }
  
  // Unified rectangle drawing function for all screen sizes
  function drawRectangles(dims, nodePositions) {
    const { gojekRect, specialRect, ministryTextY, gojekTextX, gojekTextY, specialTextX, specialTextY, googleTextY } = nodePositions;
    const { scale } = dims;
    
    // Ministry title
    svg.append("text")
        .attr("class", "circle-header")
        .attr("x", dims.centerX)
        .attr("y", ministryTextY)
        .text("Indonesia's Ministry of Education and Culture");

    // Gojek rectangle
    svg.append("rect")
        .attr("class", "group-rectangle gojek-group")
        .attr("x", gojekRect.x)
        .attr("y", gojekRect.y)
        .attr("width", gojekRect.width)
        .attr("height", gojekRect.height);
        
    svg.append("text")
        .attr("class", "gojek-text")
        .attr("x", gojekTextX)
        .attr("y", gojekTextY)
        .text("ex-Gojek");

    // Special staff rectangle
    svg.append("rect")
        .attr("class", "group-rectangle special-group")
        .attr("x", specialRect.x)
        .attr("y", specialRect.y)
        .attr("width", specialRect.width)
        .attr("height", specialRect.height);
        
    svg.append("text")
        .attr("class", "special-text")
        .attr("x", specialTextX)
        .attr("y", specialTextY)
        .text("Special staff");

    // Google Indonesia text
    svg.append("text")
        .attr("class", "circle-header")
        .attr("x", dims.centerX)
        .attr("y", googleTextY)
        .text("Google Indonesia");

    // Title and subtitle with 10px spacing
    svg.append("text")
        .attr("class", "chart-title")
        .attr("x", dims.centerX)
        .attr("y", dims.isMobile ? 20 : (25 * dims.scale))
        .text("Key people involved in laptop procurement case");

    svg.append("text")
        .attr("class", "chart-subtitle")
        .attr("x", dims.centerX)
        .attr("y", dims.isMobile ? 35 : (45 * dims.scale)) // 10px after title
        .text(dims.isMobile ? "Tap nodes for details" : "Hover over nodes for details");
  }
  
  function drawNodes(dims, nodePositions) {
    const tooltip = d3.select("#tooltip");
    const imageSize = dims.isMobile ? 30 : (50 * dims.scale);
    const imageRadius = imageSize / 2;
    
    // Square border size
    const borderSize = dims.isMobile ? 35 : (55 * dims.scale);
    const borderRadius = borderSize / 2;
    
    node = svg.selectAll("g.node")
      .data(data)
      .enter()
      .append("g")
        .attr("class", "node")
        .attr("transform", d => {
          const pos = nodePositions.positions[d.person] || { x: dims.centerX, y: dims.centerY };
          return `translate(${pos.x},${pos.y})`;
        });

    // Add touch events for mobile, mouse events for all
    node.on("touchstart", (e,d) => {
        e.preventDefault();
        tooltip.style("visibility", "visible").text(d.title);
        const touch = e.touches[0];
        tooltip.style("top", (touch.pageY + 10) + "px")
               .style("left", (touch.pageX + 10) + "px");
      })
      .on("touchend", () => {
        setTimeout(() => {
          tooltip.style("visibility", "hidden");
        }, 2000);
      })
      .on("mouseover", (e,d) => {
        tooltip.style("visibility", "visible").text(d.title);
      })
      .on("mousemove", (e) => {
        tooltip.style("top", (e.pageY + 10) + "px")
               .style("left", (e.pageX + 10) + "px");
      })
      .on("mouseout", () => {
        tooltip.style("visibility", "hidden");
      });

    // Square border instead of circle
    node.append("rect")
        .attr("class", "node-border")
        .attr("x", -borderRadius)
        .attr("y", -borderRadius)
        .attr("width", borderSize)
        .attr("height", borderSize)
        .attr("stroke", d => d.borderColor)
        .attr("fill", "none");

    // Square image instead of circular
    node.append("image")
        .attr("class", "node-image")
        .attr("xlink:href", d => d.image)
        .attr("x", -imageRadius)
        .attr("y", -imageRadius)
        .attr("width", imageSize)
        .attr("height", imageSize);

    node.append("text")
        .attr("dy", dims.isMobile ? 30 : (45 * dims.scale))
        .text(d => d.person)
        .style("font-size", dims.isMobile ? "8px" : `${10 * dims.scale}px`)
        .style("text-anchor", "middle")
        .style("fill", "#333");
  }
  
  function drawLegend(dims, nodePositions) {
    const legendData = [
      { status: "Witness", color: "steelblue" },
      { status: "Suspect", color: "#de544a" }
    ];

    const spacing    = dims.isMobile ? 50 : (80 * dims.scale);
    const squareSize = dims.isMobile ? 12 : (16 * dims.scale);
    const textOffset = dims.isMobile ? 10 : (12 * dims.scale);

    // total width = distance from first center to last center + one square width
    const totalWidth = (legendData.length - 1) * spacing + squareSize;

    // center the group by shifting left by half its width
    const legendX = dims.centerX - (totalWidth / 2);
    const legendY = nodePositions.legendY; // Use the calculated legendY

    const legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${legendX},${legendY})`);

    // draw squares centered on i*spacing
    legend.selectAll("rect")
      .data(legendData)
      .enter().append("rect")
        .attr("x", (d,i) => i * spacing - squareSize/2)
        .attr("y", -squareSize/2)
        .attr("width",  squareSize)
        .attr("height", squareSize)
        .attr("stroke", d => d.color)
        .attr("fill",   "none")
        .attr("stroke-width", dims.isMobile ? 2 : (4 * dims.scale));

    // draw labels centered also on i*spacing
    legend.selectAll("text")
      .data(legendData)
      .enter().append("text")
        // move to right edge of square + a little padding
        .attr("x", (d, i) => i * spacing + squareSize/2 + textOffset*0.45)
        .attr("y", 0)
        .attr("dy", "0.3em")
        .text(d => d.status)
        .style("text-anchor", "start")   // left-align the label
        .style("font-size", dims.isMobile ? "7px" : `${12 * dims.scale}px`);
  }

  // Load CSV data
  data = await d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRtgiSI8nDz2DcCgy2jgWWgDCR-DCgF8PMo0mDzKG28DZTJv9b4S_eFKWQFfSTNms9nlsn7nEGnBLZq/pub?gid=0&single=true&output=csv");

  // Process data
  data.forEach(d => {
    d.borderColor = d.Status === "Suspect" ? "#de544a" : "steelblue";
  });

  // Initial visualization
  createVisualization();

  // Add window resize listener with debouncing
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      createVisualization();
    }, 150);
  });
})();
</script>
</body>
</html>
